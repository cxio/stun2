# STUN 服务设计

> STUN: Session Traversal Utilities for NAT

借助于Findings公共网络，NAT内网节点可以探知自身的NAT类型、公网映射地址，并请求UDP打洞协助等。


## NAT 类型

一台连入公网的节点可能是直接的公网主机，也可能是内网中通过网关连入公网的内网主机。

公网主机可接收任意来源的连入请求，但内网主机就不一定了，这与网关的NAT映射方式有关，即NAT类型。

- `Full Cone`：完全圆锥型（`FullC`）。最宽松的一种NAT约束，网关不对来源IP:Port作任何限制，可接收任意地址的连入。
- `Restricted Cone`：受限圆锥型（`RC`）。连入的源IP需与连出时的目标IP相同，不限制端口。
- `Port Restricted Cone`：端口受限圆锥型（`P-RC`）。除了IP要一致外，连入的源Port必须就是连出的目标Port。
- `Symmetric`：对称型（`Sym`）。内网主机连出的每一个不同目标都会新建一个不同的NAT映射。

另外还有几个不属于NAT但与UDP通讯/打洞有关的网域类型：

- `UDP Firewall`：有UDP防火墙。仅主动连出的目标可以与内网节点通讯，即：先有连出，后可连入。
- `UDP Blocked`：UDP禁用。完全不提供UDP协议的通讯，全面禁用。
- `Open Internet`：开放网络（`Pub`）。没有任何约束的公网地址，支持任何连入。


### 可连通性

公网 `Pub` 和 `FullC` 类型几乎一样，可以接受任意节点的连入。但 `FullC` 类型通常部署很少。

对称型 `Sym` 对每个目标的NAT映射都不同，基本无法从第三方获得映射地址，所以也很难执行打洞操作。`Sym` 类型只能单向连入 `Pub` 或 `FullC` 类型（合称 `Pub/FullC`）节点。

`RC` 有稍为宽松的约束，`UDP Firewall` 则和 `P-RC` 相似，只要先发出了请求，就可以接受目标的回应。也即这三种类型都可以用打洞的方式创建连接。

至于 `UDP Blocked` 禁用UDP的网域，则完全无法使用 UDP 通讯了。

> **注：**
> 一个仅受限于家庭网关的公网节点可通过 UPnP 映射可成为公网节点。



## NAT 类型探测

如果客户端已经获得了多个Findings公网节点的信息，就可以向这些节点拨号连接并请求NAT相关服务。

> **注：**
> 直接接受外部连入的Findings节点只能是 `Pub/FullC` 类型，统称公网节点。


### 预探测

节点首先应当确认自己是否位于 UDP 被封禁的网域：从同一个本地端口向2个Findings公网节点尝试 QUIC 连接。

如果连接成功，则进入下一步，否则大概率 UDP 被封（`UDP Blocked`），NAT 探测无意义。

> **可靠性增强：**
> 如果无法创建 QUIC 连接，可再向2台服务器尝试。如果再失败，则基本确认UDP封禁。
> 如果有一台连接成功，则可继续尝试，直到创建第二个连接。
>
> 另外，如果节点已经TCP连接到服务器，可直接请求其UDP监听地址并尝试（服务器确定在线）。

向服务器请求获取自身 UDP 地址，然后对比：

- 不同：为 `Sym` 类型，探测结束。
- 相同：再与本地地址（LocalAddr）对比：
    - 不同（N）：待进一步测试……
    - 相同（Y）：`Open Internet` | `UDP Firewall`


### 正式探测

客户端向服务器请求 NAT 类型探测（`STUN:Cone`）服务。

服务器仅需执行两个操作：

1. `NewPort`: 用一个新的端口（随机）回复消息。
2. `NewHost`: 请求另一个服务节点（新IP）辅助，向客户端地址发送消息。


#### 1. 客户端

本地创建一个 QUIC 服务监听。

通过该监听端口向服务器拨号（创建NAT映射），发送 `STUN:Cone` 请求。数据包含：

1. SN：会话标识。
2. SPKI：本地监听证书公钥编码哈希。
3. 排除清单：预探测期间曾经连接过的目标地址。

> **注：**
> `NewHost` 协助需要一个未与客户端关联过的新IP，因此提供排除清单。


#### 2. 服务器

获取客户端公网映射地址，以及发来的数据。执行如下操作：

- `NewPort`: 用一个新的随机端口拨号到客户端。证书验证用SPKI指纹，发送数据为SN。
- `NewHost`: 请求一个不在排除清单中的组网节点向客户端发送消息。传递相关数据：
    - 客户端公网映射地址。
    - 客户端提供的 SN 和 SPKI 指纹。

协助执行 `NewHost` 的组网节点用一个任意端口拨号到客户端即可，SPKI指纹验证证书并发送SN。

> **注：**
> `NewPort` 和 `NewHost` 发送的 SN 会被前置一个标识以便区分。


#### 3. 客户端

监听2个服务端的拨号连入，以及必要的 SN 核验和区分。

> **注记：**
> 可能通过管道方式（=> Channel）通知&判断。


#### 综合判断

客户端根据 `NewPort` 和 `NewHost` 两个连入的情况，综合判断自身 NAT 类型或所在网域。

**NewPort**:
- 收到 => `RC | FullC`。注：`FullC` 在*NewHost*段确认&覆盖。
- 超时 => `P-RC | Sym` => `P-RC`。注：`Sym` 已在预探测中确认并排除。

**NewHost**:
- 收到 + 预探测.N => `FullC`。
- 收到 + 预探测.Y => `Open Internet`，即 `Pub`。
- 超时 + 预探测.Y => `UDP Firewall` 网域。


### 图示

```
                            +--------+           NewHost Request
                            | Serv.1 | ------------------------+
                            +--------+                         |
                              |    |                           |
                              |    |                           V
+--------+                    |    |                      +--------+
| Serv.0 |                    |    |                      | Serv.2 |
+--------+                    |    |                      +--------+
    |                         |    | 2)                        |
    |                      1) |    | NewPort                   | 2)
    | 1)               Addr.1 |    |                           | NewHost
    | Addr.0                  |    |                           |
    V                         V    V                           V
+-------------------------------------------------------------------+
|             LocalAddr             Received?           Received?   |
|  [Client]                                                         |
+-------------------------------------------------------------------+


1)
Addr.0 != Addr.1   ---> Sym. END.
Addr.0 == Addr.1/
    Addr.1 == LocalAddr (Y)   ---> Open Internet | UDP Firewall
    Addr.1 != LocalAddr (N)   ---> (Next Step...)

2)
NewPort: Received/
    Yes   ---> RC | FullC
    No    ---> P-RC
NewHost: Received/
    Yes & 1.N   ---> FullC
    Yes & 1.Y   ---> Open Interent (Pub)
    No & 1.Y    ---> UDP Firewall
```


### 附：NAT类型发现流程参考（RFC3489）

```
                        +--------+
                        |  Test  |
                        |   I    |
                        +--------+
                             |
                             |
                             V
                            /\              /\
                         N /  \ Y          /  \ Y             +--------+
          UDP     <-------/Resp\--------->/ IP \------------->|  Test  |
          Blocked         \ ?  /          \Same/              |   II   |
                           \  /            \? /               +--------+
                            \/              \/                    |
                                             | N                  |
                                             |                    V
                                             V                    /\
                                         +--------+  Sym.      N /  \
                                         |  Test  |  UDP    <---/Resp\
                                         |   II   |  Firewall   \ ?  /
                                         +--------+              \  /
                                             |                    \/
                                             V                     |Y
                  /\                         /\                    |
   Symmetric  N  /  \       +--------+   N  /  \                   V
      NAT  <--- / IP \<-----|  Test  |<--- /Resp\               Open
                \Same/      |   I    |     \ ?  /               Internet
                 \? /       +--------+      \  /
                  \/                         \/
                  |                           |Y
                  |                           |
                  |                           V
                  |                           Full
                  |                           Cone
                  V              /\
              +--------+        /  \ Y
              |  Test  |------>/Resp\---->Restricted
              |   III  |       \ ?  /
              +--------+        \  /
                                 \/
                                  |N
                                  |       Port
                                  +------>Restricted
```

文档：https://datatracker.ietf.org/doc/html/rfc3489#section-10.2



## 存活期探测（`STUN:Live`）

NAT映射有存活期，节点静默超时后NAT会关闭其映射。

对某些应用来说，存活期探测可能是必要的，因此本设计也提供此服务。


### 前提条件

消息通讯采用 QUIC 安全连接 + 普通 UDP 链路混合模式。

服务端运行一个由自签名支持的探测服务器（quic.Listen），已知其自签名证书的 SPKI 指纹（sha256(SPKI)）、服务器地址（IP:Port，公网或 `FullC`）。

服务器端 quic.Listen 由一个已知的 net.UDPConn 监听连接创建。


### 1. 客户端

创建一个到服务器地址的本地普通 UDP 拨号连接（net.UDPConn），
基于此连接创建一个到相同服务地址的 QUIC 拨号（quic.Conn）连接，使用服务器 SPKI 指纹验证核实证书。

QUIC 拨号会发送数据报，因此创建了到公网上的 NAT 映射。

1. 客户端向服务器请求自身公网映射地址（IP:Port）。
2. 检查映射地址与本地地址是否相同，确认自己处于 NAT 内网。
3. 关闭 quic.Conn，从 QUIC 退化到普通 UDP 通讯状态（使用 net.UDPConn）。

> **注：**
> 获取到的端口号暂存（`Port.0`），将由下一步使用。


#### 服务器响应

- 应客户端请求，发送其公网映射地址。
- 客户端关闭其 quic.Conn 连接后，响应并关闭其与服务端的 quic.Conn 连接。

> **注：**
> 关闭与客户端的 quic.Conn 不会影响上层 QUIC 监听。

即：在与客户端对应的链路上，配合客户端退化降级到纯 UDP。


### 2. 客户端

> **预备：**
> 用一个新的随机端口向同一服务节点拨号，创建 QUIC 连接（新链路）。

向服务端请求存活期探测（`STUN:Live`）服务。发送数据为：

- 计数（`Cnt`）：表达发送的时间顺序。
- 序列号标识（`SN`）：8字节，每次都随机生成。
- 端口（`Port.0`）：即初始请求创建的NAT映射，旧链路。

> **注：**
> 向服务器发送的数据采用 protoBuf 编码。

与此同时，客户端在旧链路（纯UDP）上会发送一个 PING 包，以刷新 NAT 映射，同时也重置下一探测的计时（回到零点）。


#### 服务器响应

1. 提取客户端的来源IP，以及传递来的端口（`Port.0`），组合客户端原公网映射地址。
2. 在自身监听的 net.UDPConn 原生连接上，向客户端地址写入消息：`Cnt+SN`（明码）。

> **注：**
> 服务器在原生 UDP 连接上的回应是一种“只写”逻辑。
> 虽然客户端会发送一个PING包，但服务器无需读取它，正常发送 `Cnt+SN` 即可。

考虑原生UDP链路的不可靠性，服务器每收到一个 `STUN:Live` 请求，会发送3个消息包（冗余），每个包相隔 100ms。


### 循环：客户端 <=> 服务器

客户端会多次向服务器请求 `STUN:Live` 探测（从新链路上）。

时间间隔（默认）：

- **粗测**：起始间隔从20秒开始，15秒增量（精度）。即如：20s, 35s, 50s ...，直到终点或某段超时。
- **精测**：粗测中超时失败后得到有效间隔，开启精测，精度为3秒。

其中各项参数：*起始间隔*、*粗测精度*、*精测精度*、*终点时长*（最大间隔）可由用户配置，以强化对不同网络的适应性。

> **注：**
> 起始间隔有最小值（10秒）限定，这让双方可以干净地退出 QUIC。
> 粗测和精测是各自独立的，精测需要重新走一遍流程：从初始的客户端 QUIC 拨号开始（新的NAT映射）。

所有参数的单位都为 `秒`。也因此，精测的精度最高只能到 `1秒`，不过这已足够。


### 判断

- 如果在先前的端口（`Port.0`）上收到回应，表示映射没有改变。
- 如果没有收到回应（10秒超时），表示映射已经改变，回应不可达。

> **注：**
> 客户端在旧链路上发送PING时，此处的读取超时（10s）即需重置。

如果需要，客户端可以向不止一个公共服务器请求测试，综合评估（平均）。
